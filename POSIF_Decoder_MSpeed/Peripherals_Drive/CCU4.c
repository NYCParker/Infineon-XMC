
/*
CC40 计数器 计数POSIF.OUT0  POSIF.OUT1作为增减选择器
CC41 计数圈数 POSIF.OUT4 IN1H
CC42 PLCK计数 
CC43 CC42 ST 捕获 测速 受外部同步启动
*/

#include <XMC4400.h>
#include "CCU4.h"

void CCU4_Init(void)
{
    WR_REG(SCU_RESET->PRSET0, SCU_RESET_PRSET0_CCU40RS_Msk, SCU_RESET_PRSET0_CCU40RS_Pos, 1);
	WR_REG(SCU_RESET->PRCLR0, SCU_RESET_PRCLR0_CCU40RS_Msk, SCU_RESET_PRCLR0_CCU40RS_Pos, 1);	
	WR_REG(SCU_CLK->CLKSET, SCU_CLK_CLKSET_CCUCEN_Msk, SCU_CLK_CLKSET_CCUCEN_Pos, 1);		
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_SPRB_Msk, CCU4_GIDLC_SPRB_Pos, 1);	
	
	//CC40
	WR_REG(CCU40_CC40->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, 0);
	WR_REG(CCU40_CC40->FPC, CCU4_CC4_FPC_PVAL_Msk, CCU4_CC4_FPC_PVAL_Pos, 0);
	WR_REG(CCU40_CC40->TC, CCU4_CC4_TC_CLST_Msk, CCU4_CC4_TC_CLST_Pos, 1);
	WR_REG(CCU40_CC40->TC, CCU4_CC4_TC_STRM_Msk, CCU4_CC4_TC_STRM_Pos, 1); 
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 4);  //事件0 POSIF.OUT0
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV1IS_Msk, CCU4_CC4_INS_EV1IS_Pos, 5);  //事件1 POSIF.OUT1
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV1LM_Msk, CCU4_CC4_INS_EV1LM_Pos, 0);  //低电平有效(高电平时向上计数）
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV2IS_Msk, CCU4_CC4_INS_EV2IS_Pos, 6);  //事件2 POSIF.OUT3
	WR_REG(CCU40_CC40->INS, CCU4_CC4_INS_EV2EM_Msk, CCU4_CC4_INS_EV2EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC40->CMC, CCU4_CC4_CMC_CNTS_Msk, CCU4_CC4_CMC_CNTS_Pos, 1);    //事件0：计数	
	WR_REG(CCU40_CC40->CMC, CCU4_CC4_CMC_UDS_Msk, CCU4_CC4_CMC_UDS_Pos, 2);      //事件1：增/减控制
	WR_REG(CCU40_CC40->CMC, CCU4_CC4_CMC_STRTS_Msk, CCU4_CC4_CMC_STRTS_Pos, 3);  //事件2：外部启动信号（配合TC,清空启动）
	WR_REG(CCU40_CC40->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, 0x7CF);	
	WR_REG(CCU40_CC40->CRS, CCU4_CC4_CRS_CRS_Msk, CCU4_CC4_CRS_CRS_Pos, 0x1);
	
	//CC41
	WR_REG(CCU40_CC41->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, 0);
	WR_REG(CCU40_CC41->FPC, CCU4_CC4_FPC_PVAL_Msk, CCU4_CC4_FPC_PVAL_Pos, 0);
	WR_REG(CCU40_CC41->TC, CCU4_CC4_TC_CLST_Msk, CCU4_CC4_TC_CLST_Pos, 1);
	WR_REG(CCU40_CC41->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 6);  //事件0 POSIF.OUT4
	WR_REG(CCU40_CC41->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC41->CMC, CCU4_CC4_CMC_CNTS_Msk, CCU4_CC4_CMC_CNTS_Pos, 1);    //事件0：计数
	WR_REG(CCU40_CC41->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, 0xFFFF);	
	WR_REG(CCU40_CC41->CRS, CCU4_CC4_CRS_CRS_Msk, CCU4_CC4_CRS_CRS_Pos, 0x1);
	WR_REG(CCU40_CC41->INTE, CCU4_CC4_INTE_PME_Msk, CCU4_CC4_INTE_PME_Pos, 1);		
	WR_REG(CCU40_CC41->SRS, CCU4_CC4_SRS_POSR_Msk, CCU4_CC4_SRS_POSR_Pos, 1);    //周期匹配中断
 
    //CC42
 	WR_REG(CCU40_CC42->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, 0);
	WR_REG(CCU40_CC42->FPC, CCU4_CC4_FPC_PVAL_Msk, CCU4_CC4_FPC_PVAL_Pos, 0);
	WR_REG(CCU40_CC42->TC, CCU4_CC4_TC_CLST_Msk, CCU4_CC4_TC_CLST_Pos, 1);
	WR_REG(CCU40_CC42->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 5);  //事件0 POSIF.OUT2
	WR_REG(CCU40_CC42->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC42->CMC, CCU4_CC4_CMC_CNTS_Msk, CCU4_CC4_CMC_CNTS_Pos, 1);    //事件0：计数	
	WR_REG(CCU40_CC42->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, 0x14);	
	WR_REG(CCU40_CC42->CRS, CCU4_CC4_CRS_CRS_Msk, CCU4_CC4_CRS_CRS_Pos, 0x1); 
 
    //CC43
 	WR_REG(CCU40_CC43->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, 4);
	WR_REG(CCU40_CC43->FPC, CCU4_CC4_FPC_PVAL_Msk, CCU4_CC4_FPC_PVAL_Pos, 4);
	WR_REG(CCU40_CC43->TC, CCU4_CC4_TC_CLST_Msk, CCU4_CC4_TC_CLST_Pos, 1);
	WR_REG(CCU40_CC43->TC, CCU4_CC4_TC_CMOD_Msk, CCU4_CC4_TC_CMOD_Pos, 1);       //捕获模式
	WR_REG(CCU40_CC43->TC, CCU4_CC4_TC_CAPC_Msk, CCU4_CC4_TC_CAPC_Pos, 3);       //捕获清空定时器
	WR_REG(CCU40_CC43->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 5);  //事件0 POSIF.OUT5
	WR_REG(CCU40_CC43->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC43->INS, CCU4_CC4_INS_EV1IS_Msk, CCU4_CC4_INS_EV1IS_Pos, 14); //事件1 CCU40.ST2
	WR_REG(CCU40_CC43->INS, CCU4_CC4_INS_EV1EM_Msk, CCU4_CC4_INS_EV1EM_Pos, 1);  //上升沿有效
	WR_REG(CCU40_CC43->CMC, CCU4_CC4_CMC_STRTS_Msk, CCU4_CC4_CMC_STRTS_Pos, 1);  //事件0：外部启动
	WR_REG(CCU40_CC43->CMC, CCU4_CC4_CMC_CAP0S_Msk, CCU4_CC4_CMC_CAP0S_Pos, 2);  //事件1：捕获
	WR_REG(CCU40_CC43->INTE, CCU4_CC4_INTE_E1AE_Msk, CCU4_CC4_INTE_E1AE_Pos, 1);		
    WR_REG(CCU40_CC43->SRS, CCU4_CC4_SRS_E1SR_Msk, CCU4_CC4_SRS_E1SR_Pos, 1);
	WR_REG(CCU40_CC43->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, 0xFFFF);	
	WR_REG(CCU40_CC43->CRS, CCU4_CC4_CRS_CRS_Msk, CCU4_CC4_CRS_CRS_Pos, 0x1); 

	WR_REG(CCU40->GCSS, CCU4_GCSS_S0SE_Msk, CCU4_GCSS_S0SE_Pos, 1);		
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS0I_Msk, CCU4_GIDLC_CS0I_Pos, 1);	
	WR_REG(CCU40->GCSS, CCU4_GCSS_S1SE_Msk, CCU4_GCSS_S1SE_Pos, 1);		
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS1I_Msk, CCU4_GIDLC_CS1I_Pos, 1);	
	WR_REG(CCU40->GCSS, CCU4_GCSS_S2SE_Msk, CCU4_GCSS_S2SE_Pos, 1);		
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS2I_Msk, CCU4_GIDLC_CS2I_Pos, 1);	
	WR_REG(CCU40->GCSS, CCU4_GCSS_S3SE_Msk, CCU4_GCSS_S3SE_Pos, 1);		
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS3I_Msk, CCU4_GIDLC_CS3I_Pos, 1);		
}

void CCU40_CC40_Start()
{
	WR_REG(CCU40_CC40->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC40
}

void CCU40_CC41_Start()
{
	WR_REG(CCU40_CC41->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC41
}

void CCU40_CC42_Start()
{
	WR_REG(CCU40_CC42->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC42
}
